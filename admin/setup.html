<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Quick Start â€” Create & Upload (Horizon UI Â· Roboto)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --bg:#f4f7fe;--card:#fff;--text:#1b2559;--muted:#707eae;--primary:#4318ff;--primary-600:#3a14e0;
      --border:#e9ecf8;--border-strong:#dfe4ff;--chip:#f1f5ff;--ring:0 8px 24px rgba(20,20,43,.06);
      --radius:16px;--radius-lg:20px;--space-1:4px;--space-2:8px;--space-3:12px;--space-4:16px;--space-5:20px;--space-6:24px
    }
    [data-theme="dark"]{--bg:#0f1228;--card:#131735;--text:#e8ebff;--muted:#98a1c6;--primary:#7c6bff;--primary-600:#6e5ff6;--border:#2a2f57;--border-strong:#3a4180;--chip:#1b2046;--ring:0 8px 24px rgba(0,0,0,.4)}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Roboto,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Arial;background:var(--bg);color:var(--text)}
    a{color:var(--primary);text-decoration:none}
    .wrap{max-width:980px;margin:28px auto 60px;padding:0 20px}
    .hero{background: radial-gradient(1200px 400px at 20% -10%, rgba(67,24,255,0.20), transparent 60%), radial-gradient(1200px 400px at 100% 0%, rgba(67,24,255,0.10), transparent 60%), var(--card); border:1px solid var(--border); box-shadow:var(--ring); border-radius:var(--radius-lg); padding:24px; display:flex; align-items:center; justify-content:space-between}
    .badge{background:#ede9fe;color:#5b21b6;border:1px solid #e0d4ff;padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px}
    .title{font-size:26px;font-weight:900;margin-top:6px}
    .card{background:var(--card);border-radius:var(--radius-lg);box-shadow:var(--ring);border:1px solid var(--border);margin-top:18px;overflow:hidden}
    .card-head{padding:18px 22px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .card-body{padding:22px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid var(--border-strong);border-radius:999px;padding:6px 10px;font-size:12px}
    .divider{height:1px;background:var(--border);margin:var(--space-5) 0}
    .form-grid{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:var(--space-4)}
    .col-12{grid-column:span 12/span 12}.col-6{grid-column:span 6/span 6}
    @media(max-width:900px){.col-6{grid-column:span 12/span 12}}
    .field{display:flex;flex-direction:column;gap:var(--space-2)}
    .field label{font-size:12px;color:var(--muted)}
    .help{font-size:12px;color:var(--muted);margin:0}
    .input,textarea{width:100%;border:1px solid var(--border);border-radius:12px;background:#fff;color:var(--text);outline:none}
    .input{height:44px;padding:10px 12px} textarea{min-height:96px;padding:12px}
    .uploader{border:1.5px dashed #d7defc;border-radius:16px;padding:22px;text-align:center;color:var(--muted);background:#fff;cursor:pointer}
    .uploader.drag{background:#f3f6ff}
    .file{background:#f6f8ff;border:1px solid #e7ebff;border-left:4px solid var(--primary);padding:10px 12px;border-radius:12px;font-size:13px;display:flex;justify-content:space-between;gap:10px;align-items:center}
    .progress{height:8px;background:#eaefff;border-radius:999px;overflow:hidden} .progress>span{display:block;height:100%;background:var(--primary);width:0%}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .btn{border:0;border-radius:12px;padding:11px 16px;font-weight:800;cursor:pointer;background:var(--primary);color:#fff;box-shadow:0 8px 16px rgba(67,24,255,.18)}
    .btn.secondary{background:#eef2ff;color:#3730a3;box-shadow:none}
    .btn.ghost{background:#fff;border:1px solid var(--border);color:#1f2937;box-shadow:none}
    .alert{padding:12px 14px;border-radius:12px;font-size:14px;margin:12px 0;border:1px solid;background:#eff6ff;border-color:#bfdbfe;color:#1e40af}
    .alert.success{background:#ecfdf5;border-color:#bbf7d0;color:#166534}
    .alert.error{background:#fef2f2;border-color:#fecaca;color:#991b1b}
    .sticky{position:sticky;bottom:0;background:linear-gradient(180deg,rgba(244,247,254,0) 0%, rgba(244,247,254,1) 20%);padding-top:8px;margin-top:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <section class="hero">
      <div>
        <span class="badge">Quick Start</span>
        <div class="title">Create Business & Upload</div>
        <div class="chips" style="margin-top:8px">
          <span class="chip">Profile âœ“</span><span class="chip">Documents âœ“</span><span class="chip">Notifications âœ“</span><span class="chip">Lead capture âœ“</span>
        </div>
      </div>
      <a class="btn ghost" href="./index.html">Open Dashboard</a>
    </section>

    <section class="card">
      <div class="card-head"><div class="h">Unified Setup</div></div>
      <form id="form" class="card-body" novalidate>
        <div class="form-grid">
          <div class="field col-6"><label for="name">Business Name *</label><input id="name" class="input" required placeholder="Acme Dental Clinic"/></div>
          <div class="field col-6"><label for="slug">URL Slug *</label><input id="slug" class="input" required pattern="[a-z0-9-]+" placeholder="acme-dental"/><div class="help">Lowercase, numbers and dashes only</div></div>
          <div class="field col-12"><label for="desc">Description</label><textarea id="desc" placeholder="Brief descriptionâ€¦" ></textarea></div>
          <div class="field col-6"><label for="email">Business Email</label><input id="email" class="input" type="email" placeholder="hello@acmeclinic.com"/></div>
          <div class="field col-6"><label for="phone">Phone Number</label><input id="phone" class="input" type="tel" placeholder="+1 (555) 000-0000"/></div>
          <div class="field col-12"><label for="address">Address</label><input id="address" class="input" placeholder="123 Main St, City, Country"/></div>
          <div class="field col-6"><label for="website">Website URL</label><input id="website" class="input" type="url" placeholder="https://acmeclinic.com"/></div>
          <div class="field col-6"><label for="hours">Business Hours</label><input id="hours" class="input" placeholder="Monâ€“Fri 9AMâ€“6PM"/></div>
          <div class="field col-12"><label for="maps">Google Maps URL</label><input id="maps" class="input" type="url" placeholder="https://maps.google.com/?q=Your+Business"/></div>
          <div class="field col-6"><label for="color">Primary Color</label><input id="color" class="input" type="color" value="#6a5cff"/></div>
          <div class="field col-6"><label for="logo">Logo URL (Optional)</label><input id="logo" class="input" type="url" placeholder="https://â€¦/logo.png"/></div>
          <div class="field col-12"><label for="welcome">Welcome Message</label><textarea id="welcome" placeholder="Hi! How can I help you today?"></textarea></div>
        </div>

        <div class="divider"></div>

        <div class="h" style="margin-bottom:8px">Upload Knowledge</div>
        <p class="muted" style="margin-bottom:8px">PDF, CSV, XLSX, DOCX, TXT â€¢ Max 10MB each</p>
        <div id="dz" class="uploader" tabindex="0">ðŸ“„ <strong>Drag & drop</strong> files here or <u>browse</u><input id="file" type="file" multiple accept=".pdf,.csv,.xlsx,.xls,.docx,.txt" style="display:none"/></div>
        <div id="list" style="display:grid;gap:8px;margin-top:10px"></div>

        <div class="sticky">
          <div id="note" class="alert" style="display:none" role="status" aria-live="polite"></div>
          <div class="actions">
            <button class="btn" type="submit">Create Business & Upload</button>
            <button class="btn secondary" type="button" id="uploadOnly">Upload Only</button>
            <button class="btn ghost" type="button" id="resetBtn">Reset</button>
          </div>
          <div id="out" style="display:grid;gap:8px;margin-top:10px"></div>
        </div>
      </form>
    </section>
  </div>

  <script>
    const $ = s=>document.querySelector(s);
    let files = [];

    // Dropzone with per-file progress
    const dz=$('#dz'), input=$('#file');
    dz.onclick=()=>input.click();
    dz.addEventListener('dragover',e=>{e.preventDefault(); dz.classList.add('drag')});
    dz.addEventListener('dragleave',()=>dz.classList.remove('drag'));
    dz.addEventListener('drop',e=>{e.preventDefault(); dz.classList.remove('drag'); handle(e.dataTransfer.files)});
    input.onchange=(e)=>handle(e.target.files);

    const okExt=['pdf','csv','xlsx','xls','docx','txt']; const maxSize=10*1024*1024;
    function handle(fileList){
      const arr=Array.from(fileList); arr.forEach(f=>{
        const ext=(f.name.split('.').pop()||'').toLowerCase();
        if(!okExt.includes(ext)) return msg('Skipped '+f.name+' (type)','error');
        if(f.size>maxSize) return msg('Skipped '+f.name+' (>10MB)','error');
        files.push({id:crypto.randomUUID(), file:f, status:'queued', progress:0, error:null});
      });
      renderList();
    }
    function renderList(){
      const box=$('#list'); box.innerHTML='';
      files.forEach((it,i)=>{
        const row=document.createElement('div'); row.className='file';
        row.innerHTML=`<div style="flex:1">
            <div><strong>${it.file.name}</strong> <span class="muted">â€¢ ${(it.file.size/1024/1024).toFixed(2)} MB</span></div>
            <div class="progress"><span id="p-${it.id}" style="width:${it.progress}%"></span></div>
            <div class="muted" id="s-${it.id}">${it.status}</div>
          </div>
          <div class="actions">
            <button class="btn ghost" data-retry="${it.id}" ${it.status!=='error'?'disabled':''}>Retry</button>
            <button class="btn secondary" data-remove="${i}">Remove</button>
          </div>`;
        box.appendChild(row);
      });
      box.querySelectorAll('[data-remove]').forEach(b=>b.onclick=()=>{ files.splice(b.dataset.remove,1); renderList();});
      box.querySelectorAll('[data-retry]').forEach(b=>b.onclick=()=>{ const it=files.find(x=>x.id===b.dataset.retry); if(it){it.status='queued'; it.error=null; it.progress=0; renderList();}});
    }

    function msg(t,type='info'){ const n=$('#note'); n.className='alert'+(type==='success'?' success':type==='error'?' error':''); n.style.display='block'; n.textContent=t }
    function hideMsg(){ $('#note').style.display='none' }

    function sanitizeSlug(v){ return (v||'').toLowerCase().replace(/[^a-z0-9-]/g,'').replace(/--+/g,'-').replace(/^-+|-+$/g,'') }

    async function create(payload){
      const res=await fetch('/admin/business/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const j=await res.json(); if(!j.success) throw new Error(j.error||'Create failed'); return j;
    }
    function uploadFile(slug, item){
      item.status='uploading'; updateRow(item);
      return new Promise(resolve=>{
        const form=new FormData(); form.append('files', item.file);
        const xhr=new XMLHttpRequest();
        xhr.upload.addEventListener('progress',(e)=>{ if(e.lengthComputable){ item.progress=Math.round((e.loaded/e.total)*100); updateRow(item); }});
        xhr.onreadystatechange=()=>{ if(xhr.readyState===4){ if(xhr.status>=200&&xhr.status<300){ item.progress=100; item.status='done'; updateRow(item); resolve(true);} else { item.status='error'; item.error=xhr.responseText||'Upload failed'; updateRow(item); resolve(false);} } };
        xhr.open('POST', `/admin/business/${encodeURIComponent(slug)}/upload`); xhr.send(form);
      });
    }
    function updateRow(item){ const p=$(`#p-${item.id}`), s=$(`#s-${item.id}`); if(p) p.style.width=item.progress+'%'; if(s) s.textContent=item.status+(item.error?` â€¢ ${item.error}`:''); }

    async function run(includeCreate){
      $('#out').innerHTML=''; hideMsg();
      const slugInput=$('#slug'); slugInput.value=sanitizeSlug(slugInput.value); const slug=slugInput.value;
      if(!slug){ msg('Provide a valid slug.','error'); return; }
      if(files.length===0 && !includeCreate){ msg('Choose at least one file.','error'); return; }

      const payload={
        slug, name:$('#name').value, description:$('#desc').value, email:$('#email').value, phone:$('#phone').value,
        address:$('#address').value, website:$('#website').value, hours:$('#hours').value, maps_url:$('#maps').value||'',
        primary_color:$('#color').value||'#6a5cff', logo_url:$('#logo').value, welcome_message:$('#welcome').value,
        enable_email_notifications:true, enable_lead_capture:true
      };

      try{
        let created;
        if(includeCreate){
          msg('Creating businessâ€¦');
          created=await create(payload);
          const card=document.createElement('div'); card.className='file';
          card.innerHTML=`âœ… <strong>Created:</strong> ${created.business?.name||'-'} â€¢ <a href="${created?.urls?.chatUrl||'#'}" target="_blank" rel="noopener">Open chat</a>`;
          $('#out').appendChild(card);
        }
        if(files.length){
          msg('Uploading filesâ€¦');
          for(const item of files){ if(item.status==='done') continue; await uploadFile(slug, item); }
          const ok = files.filter(f=>f.status==='done').length;
          const wrap=document.createElement('div'); wrap.className='file';
          wrap.innerHTML=`ðŸ“Š <strong>Results</strong> â€” Files: ${ok} / ${files.length}`;
          $('#out').appendChild(wrap);
        }
        msg('All done ðŸŽ‰','success');
      }catch(e){ msg('Error: '+(e.message||'Something went wrong'),'error'); }
    }

    $('#form').addEventListener('submit',(e)=>{e.preventDefault(); run(true)});
    $('#uploadOnly').onclick=()=>run(false);
    $('#resetBtn').onclick=()=>{ $('#form').reset(); files=[]; $('#list').innerHTML=''; hideMsg(); $('#out').innerHTML=''; }
    $('#slug').addEventListener('input',(e)=> e.target.value = sanitizeSlug(e.target.value));
  </script>
</body>
</html>
