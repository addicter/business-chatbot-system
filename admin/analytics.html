<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Business Analytics - Horizon Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f4f7fe; --card:#ffffff; --text:#1b2559; --muted:#a3aed0;
      --primary:#4318ff; --success:#05cd99; --warning:#ffb547; --error:#e31a1a;
      --border:#e9ecf7; --hover:#f4f7fe; --shadow:0px 18px 40px rgba(112, 144, 176, 0.12);
      --radius: 20px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: 'DM Sans', ui-sans-serif, system-ui, -apple-system, sans-serif;
      background:var(--bg); color:var(--text); line-height:1.6;
    }
    .container{max-width:1200px; margin:0 auto; padding:24px}
    .header{
      background:linear-gradient(135deg, var(--primary) 0%, #6c5ce7 100%);
      color:white; padding:32px; border-radius:var(--radius); margin-bottom:32px;
      box-shadow:var(--shadow);
    }
    .header h1{font-size:28px; font-weight:700; margin-bottom:8px}
    .header p{opacity:0.9; font-size:16px}
    .header .breadcrumb{
      background:rgba(255,255,255,0.1); padding:8px 16px;
      border-radius:12px; font-size:14px; margin-top:16px; display:inline-block;
    }
    
    .stats-grid{display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:20px; margin-bottom:32px}
    .stat-card{
      background:var(--card); border-radius:var(--radius); padding:24px;
      box-shadow:var(--shadow); border:1px solid var(--border);
    }
    .stat-header{display:flex; align-items:center; justify-content:space-between; margin-bottom:16px}
    .stat-icon{
      width:48px; height:48px; border-radius:12px; display:flex; align-items:center;
      justify-content:center; font-size:20px; color:white;
    }
    .stat-icon.conversations{background:var(--primary)}
    .stat-icon.leads{background:var(--success)}
    .stat-icon.messages{background:var(--warning)}
    .stat-icon.conversion{background:var(--error)}
    .stat-number{font-size:32px; font-weight:700; color:var(--text)}
    .stat-label{color:var(--muted); font-size:14px; margin-top:4px}
    .stat-change{font-size:12px; color:var(--success); margin-top:8px}
    
    .chart-grid{display:grid; grid-template-columns:2fr 1fr; gap:24px; margin-bottom:32px}
    @media (max-width:900px){.chart-grid{grid-template-columns:1fr}}
    
    .chart-card{
      background:var(--card); border-radius:var(--radius); padding:24px;
      box-shadow:var(--shadow); border:1px solid var(--border);
    }
    .chart-header{
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:20px; padding-bottom:16px; border-bottom:1px solid var(--border);
    }
    .chart-title{font-size:18px; font-weight:600; color:var(--text)}
    .chart-period{
      padding:6px 12px; background:var(--hover); border-radius:8px;
      font-size:12px; color:var(--muted);
    }
    
    .intent-list{display:flex; flex-direction:column; gap:12px}
    .intent-item{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 16px; background:var(--hover); border-radius:12px;
    }
    .intent-name{font-weight:500; color:var(--text)}
    .intent-count{
      background:var(--primary); color:white; padding:4px 8px;
      border-radius:8px; font-size:12px; font-weight:500;
    }
    
    .daily-chart{height:300px; display:flex; align-items:end; gap:8px; padding:20px 0}
    .chart-bar{
      background:linear-gradient(180deg, var(--primary), #6c5ce7);
      border-radius:4px 4px 0 0; min-width:20px; position:relative;
      display:flex; flex-direction:column; align-items:center;
    }
    .chart-bar-label{
      position:absolute; bottom:-25px; font-size:10px; color:var(--muted);
      white-space:nowrap; transform:rotate(-45deg); transform-origin:center;
    }
    .chart-bar-value{
      position:absolute; top:-20px; font-size:10px; color:var(--text);
      font-weight:500;
    }
    
    .leads-table{
      background:var(--card); border-radius:var(--radius); padding:24px;
      box-shadow:var(--shadow); border:1px solid var(--border);
    }
    .table-header{
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:20px; padding-bottom:16px; border-bottom:1px solid var(--border);
    }
    .table{width:100%; border-collapse:collapse}
    .table th{
      text-align:left; padding:12px; color:var(--muted); font-weight:500;
      font-size:12px; text-transform:uppercase; letter-spacing:0.5px;
    }
    .table td{padding:16px 12px; border-top:1px solid var(--border); vertical-align:top}
    .table tr:hover{background:var(--hover)}
    .lead-name{font-weight:500; color:var(--text)}
    .lead-email{color:var(--muted); font-size:14px}
    .lead-interest{
      background:var(--hover); padding:4px 8px; border-radius:6px;
      font-size:12px; color:var(--text);
    }
    .lead-date{color:var(--muted); font-size:12px}
    
    .loading{
      display:flex; align-items:center; justify-content:center;
      height:200px; color:var(--muted);
    }
    .spinner{
      width:32px; height:32px; border:3px solid var(--border);
      border-top:3px solid var(--primary); border-radius:50%;
      animation:spin 1s linear infinite; margin-right:16px;
    }
    @keyframes spin{0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)}}
    
    .error{
      background:var(--card); border-radius:var(--radius); padding:40px;
      text-align:center; border:1px solid var(--error); color:var(--error);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 id="businessName">Business Analytics</h1>
      <p>Real-time insights and performance metrics for your chatbot</p>
      <div class="breadcrumb" id="chatLink" style="display:none;">
        <a href="#" style="color:white; text-decoration:none;">üîó Open Chat Interface</a>
      </div>
    </div>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      <span>Loading analytics data...</span>
    </div>

    <div id="dashboard" style="display:none;">
      <!-- Key Metrics -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-icon conversations">üí¨</div>
          </div>
          <div class="stat-number" id="totalSessions">0</div>
          <div class="stat-label">Total Conversations</div>
          <div class="stat-change">+12% from last period</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-icon leads">üéØ</div>
          </div>
          <div class="stat-number" id="totalLeads">0</div>
          <div class="stat-label">Leads Generated</div>
          <div class="stat-change">+8% from last period</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-icon messages">üí≠</div>
          </div>
          <div class="stat-number" id="avgMessages">0</div>
          <div class="stat-label">Avg Messages/Chat</div>
          <div class="stat-change">+15% engagement</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-icon conversion">üìà</div>
          </div>
          <div class="stat-number" id="conversionRate">0%</div>
          <div class="stat-label">Conversion Rate</div>
          <div class="stat-change">+5% improvement</div>
        </div>
      </div>

      <!-- Charts -->
      <div class="chart-grid">
        <div class="chart-card">
          <div class="chart-header">
            <div class="chart-title">Daily Activity</div>
            <div class="chart-period" id="period">Last 30 days</div>
          </div>
          <div class="daily-chart" id="dailyChart"></div>
        </div>
        
        <div class="chart-card">
          <div class="chart-header">
            <div class="chart-title">Top Customer Intents</div>
          </div>
          <div class="intent-list" id="intentsList"></div>
        </div>
      </div>

      <!-- Recent Leads Table -->
      <div class="leads-table">
        <div class="table-header">
          <div class="chart-title">Recent Leads</div>
        </div>
        <table class="table">
          <thead>
            <tr>
              <th>Contact</th>
              <th>Interest</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody id="leadsTable"></tbody>
        </table>
      </div>
    </div>

    <div id="error" class="error" style="display:none;">
      <h3>‚ùå Analytics Not Available</h3>
      <p>Unable to load analytics data. Please check your analytics URL.</p>
    </div>
  </div>

  <script>
    const analyticsHash = window.location.pathname.split('/').pop();
    
    async function loadAnalytics() {
      try {
        const response = await fetch(`/api/analytics/${analyticsHash}`);
        if (!response.ok) throw new Error('Analytics not found');
        
        const data = await response.json();
        
        // Update header
        document.getElementById('businessName').textContent = `${data.business.name} - Analytics`;
        const chatLink = document.getElementById('chatLink');
        if (data.business.chat_hash) {
          const chatUrl = `${window.location.origin}/chat/${data.business.chat_hash}`;
          chatLink.style.display = 'inline-block';
          chatLink.querySelector('a').href = chatUrl;
        }
        
        // Update metrics
        document.getElementById('totalSessions').textContent = data.analytics.totalSessions;
        document.getElementById('totalLeads').textContent = data.analytics.totalLeads;
        document.getElementById('avgMessages').textContent = data.analytics.avgMessagesPerSession;
        document.getElementById('conversionRate').textContent = `${data.analytics.conversionRate}%`;
        document.getElementById('period').textContent = `${data.period}`;
        
        // Render daily chart
        renderDailyChart(data.analytics.dailyStats);
        
        // Render intents
        renderIntents(data.analytics.topIntents);
        
        // Render leads table
        renderLeadsTable(data.analytics.recentLeads);
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        
      } catch (error) {
        console.error('Error loading analytics:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
      }
    }
    
    function renderDailyChart(dailyStats) {
      const chart = document.getElementById('dailyChart');
      if (!dailyStats || dailyStats.length === 0) {
        chart.innerHTML = '<p style="text-align:center; color:var(--muted);">No data available</p>';
        return;
      }
      
      const maxSessions = Math.max(...dailyStats.map(d => d.sessions));
      const chartHeight = 260;
      
      chart.innerHTML = dailyStats.map(day => {
        const height = maxSessions > 0 ? (day.sessions / maxSessions) * chartHeight : 0;
        const date = new Date(day.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        
        return `
          <div class="chart-bar" style="height: ${height}px; flex: 1;">
            <div class="chart-bar-value">${day.sessions}</div>
            <div class="chart-bar-label">${date}</div>
          </div>
        `;
      }).join('');
    }
    
    function renderIntents(topIntents) {
      const list = document.getElementById('intentsList');
      if (!topIntents || topIntents.length === 0) {
        list.innerHTML = '<p style="text-align:center; color:var(--muted); padding:20px;">No intent data available</p>';
        return;
      }
      
      list.innerHTML = topIntents.map(intent => `
        <div class="intent-item">
          <div class="intent-name">${intent.intent}</div>
          <div class="intent-count">${intent.count}</div>
        </div>
      `).join('');
    }
    
    function renderLeadsTable(recentLeads) {
      const table = document.getElementById('leadsTable');
      if (!recentLeads || recentLeads.length === 0) {
        table.innerHTML = '<tr><td colspan="3" style="text-align:center; color:var(--muted); padding:40px;">No recent leads</td></tr>';
        return;
      }
      
      table.innerHTML = recentLeads.map(lead => {
        const date = new Date(lead.created_at).toLocaleDateString('en-US', { 
          month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' 
        });
        
        return `
          <tr>
            <td>
              <div class="lead-name">${lead.name}</div>
              <div class="lead-email">${lead.email}</div>
              ${lead.phone ? `<div class="lead-email">${lead.phone}</div>` : ''}
            </td>
            <td>
              ${lead.interest ? `<div class="lead-interest">${lead.interest}</div>` : '<span style="color:var(--muted)">General inquiry</span>'}
            </td>
            <td>
              <div class="lead-date">${date}</div>
            </td>
          </tr>
        `;
      }).join('');
    }
    
    // Load analytics on page load
    loadAnalytics();
    
    // Refresh every 30 seconds
    setInterval(loadAnalytics, 30000);
  </script>
</body>
</html>