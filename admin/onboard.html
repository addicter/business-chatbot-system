<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Business Onboarding</title>
  <style>
    :root{
      --bg1:#f8fafc; --bg2:#eef2f7; --card:#ffffff; --text:#0f172a; --muted:#475569;
      --border:#e2e8f0; --border-strong:#cbd5e1; --primary:#4f46e5; --accent:#10b981;
      --danger:#ef4444; --ring:rgba(79,70,229,.25); --shadow:0 8px 24px rgba(15,23,42,.06);
      --rounded-lg:16px; --rounded-md:12px; --rounded-sm:10px;
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg1:#0b1220; --bg2:#0a0f1a; --card:#0d1628; --text:#e6eefc; --muted:#c3d0e6;
             --border:#1e2a44; --border-strong:#263556; --ring:rgba(99,102,241,.35);
             --shadow:0 8px 24px rgba(0,0,0,.35);
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial;
      color:var(--text);
      background:linear-gradient(180deg,var(--bg1),var(--bg2));
      padding:24px;
    }
    .wrap{max-width:880px;margin:0 auto}
    /* Header card */
    .hero{
      position:relative;
      border:1px solid var(--border);
      background:color-mix(in oklab,var(--card), transparent 0%);
      border-radius:var(--rounded-lg);
      padding:24px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .hero h1{margin:0;font-size:28px;letter-spacing:-.01em}
    .hero p{margin:6px 0 0;color:var(--muted);font-size:14px}

    .bubble{
      position:absolute; filter:blur(28px); opacity:.5; pointer-events:none;
    }
    .b1{right:-90px; top:-90px; width:210px; height:210px; border-radius:999px; background:radial-gradient(120px 120px at 60% 40%, #5b7cfa55, #34d39933 60%, transparent 70%)}
    .b2{left:-70px; bottom:-110px; width:180px; height:180px; border-radius:999px; background:radial-gradient(100px 100px at 60% 40%, #38bdf855, #a78bfa33 60%, transparent 70%)}

    .card{
      border:1px solid var(--border);
      background:var(--card);
      border-radius:var(--rounded-lg);
      padding:20px;
      margin-top:18px;
      box-shadow:var(--shadow);
    }
    .title{font-weight:600;font-size:18px;margin:0}
    .subtitle{margin:6px 0 0;color:var(--muted);font-size:14px}

    .grid{display:grid; gap:16px}
    .field label{
      display:block; font-size:14px; font-weight:600; margin-bottom:6px;
    }
    .req{color:var(--danger);margin-left:4px}
    .opt{color:var(--muted);font-weight:500;margin-left:6px}
    .input{
      width:100%; padding:10px 12px; border:1px solid var(--border-strong);
      border-radius:12px; background:var(--card); color:var(--text); outline:none;
      transition: box-shadow .15s, border-color .15s;
    }
    .input:focus{ box-shadow:0 0 0 6px var(--ring); border-color:var(--primary) }
    .help{margin:6px 0 0; font-size:12px; color:var(--muted)}
    .error{margin:6px 0 0; font-size:12px; color:var(--danger)}
    .input[aria-invalid="true"]{ border-color:var(--danger) }
    .text-sm{font-size:13px}
    .muted{color:var(--muted)}

    /* Dropzone */
    .drop{
      border:2px dashed var(--border-strong);
      border-radius:var(--rounded-md);
      padding:22px;
      text-align:center;
      transition:border-color .2s, background .2s, box-shadow .2s;
    }
    .drop:focus{ outline:none; box-shadow:0 0 0 6px var(--ring); border-color:var(--primary)}
    .drop.hover{ border-color:var(--primary); background:color-mix(in oklab,var(--card), var(--primary) 5%) }
    .pick-btn{
      margin-top:10px; border:1px solid var(--border-strong); background:transparent; color:var(--text);
      padding:8px 12px; border-radius:10px; cursor:pointer;
    }
    .pick-btn:hover{ background:color-mix(in oklab,var(--card), var(--text) 5%) }

    /* File list */
    .filelist{margin-top:14px;border:1px solid var(--border);border-radius:14px;overflow:hidden}
    .fileitem{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 12px; border-top:1px solid var(--border)}
    .fileitem:first-child{border-top:0}
    .ext{
      display:inline-flex; align-items:center; justify-content:center; width:32px; height:32px;
      border-radius:10px; background:color-mix(in oklab,var(--text), transparent 90%); color:var(--text);
      font-size:11px; font-weight:700; text-transform:uppercase;
    }
    .filename{font-size:14px; font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:56vw}
    .meta{font-size:12px; color:var(--muted)}
    .remove{
      border:1px solid var(--border-strong); padding:6px 10px; border-radius:10px; background:transparent; cursor:pointer;
    }
    .remove:hover{ background:color-mix(in oklab,var(--card), var(--text) 6%) }

    /* Buttons */
    .actions{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:16px}
    .primary{
      background:linear-gradient(135deg, var(--primary), var(--accent));
      color:#fff; border:0; padding:10px 16px; border-radius:12px; cursor:pointer;
      box-shadow:0 6px 16px rgba(16,185,129,.25);
    }
    .primary:disabled{opacity:.6; cursor:not-allowed}
    .link{background:none;border:0;padding:0;color:var(--muted);text-decoration:underline;cursor:pointer}
    .link:disabled{opacity:.5;cursor:not-allowed}

    /* Status + result */
    .status{margin-top:10px; font-size:14px}
    .status.error{color:var(--danger)}
    .status.success{color:var(--accent)}
    .result{
      margin-top:12px; border:1px solid color-mix(in oklab,var(--accent), transparent 65%);
      background:color-mix(in oklab,var(--accent), transparent 90%); border-radius:14px; padding:14px;
    }
    .result a{ color:inherit; text-decoration:underline }

    /* Progress */
    .progress{position:relative; height:10px; background:var(--border); border-radius:999px; overflow:hidden}
    .bar{height:100%; width:0%; background:linear-gradient(90deg,var(--primary),var(--accent)); transition:width .15s}

    /* Footer note */
    .tiny{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <section class="hero">
      <div class="bubble b1" aria-hidden="true"></div>
      <div class="bubble b2" aria-hidden="true"></div>
      <h1>Business Onboarding</h1>
      <p>Create your business and upload documents in one step.</p>
    </section>

    <!-- Business details -->
    <section class="card" aria-labelledby="sec-details">
      <h2 id="sec-details" class="title">Business details</h2>
      <p class="subtitle">Create the business profile you'll upload documents into.</p>

      <div class="grid" style="margin-top:16px">
        <div class="field">
          <label for="biz-name">Business name <span class="req" aria-hidden="true">*</span></label>
          <input id="biz-name" class="input" type="text" placeholder="Acme Corp" aria-describedby="name-help name-err" required />
          <div id="name-help" class="help">The display name your team will see.</div>
          <div id="name-err" class="error" role="alert" style="display:none"></div>
        </div>

        <div class="field">
          <label for="biz-slug">Slug <span class="req" aria-hidden="true">*</span></label>
          <input id="biz-slug" class="input" type="text" placeholder="acme-corp" aria-describedby="slug-help slug-err" required />
          <div id="slug-help" class="help">Unique identifier (letters, numbers, dashes).</div>
          <div id="slug-err" class="error" role="alert" style="display:none"></div>
        </div>

        <div class="field">
          <label for="biz-email">Contact email <span class="opt">(optional)</span></label>
          <input id="biz-email" class="input" type="email" placeholder="ops@acme.com" aria-describedby="email-err" />
          <div id="email-err" class="error" role="alert" style="display:none"></div>
        </div>
      </div>
    </section>

    <!-- Documents -->
    <section class="card" aria-labelledby="sec-docs">
      <h2 id="sec-docs" class="title">Documents</h2>
      <p class="subtitle">Drag & drop or pick files. Accepted: PDF, CSV, TXT, DOCX, XLSX, XLS.</p>

      <div class="grid" style="margin-top:14px">
        <div class="field">
          <!-- hidden file input to trigger native file picker -->
          <input id="file-input" type="file" multiple accept=".pdf,.csv,.txt,.docx,.xlsx,.xls"
                 style="position:absolute;width:0.1px;height:0.1px;opacity:0;overflow:hidden;z-index:-1;" />

          <div id="dz" class="drop" tabindex="0" role="button" aria-describedby="dz-hint" aria-label="Upload documents (drop files here or choose files)">
            <div>
              <svg width="36" height="36" viewBox="0 0 24 24" aria-hidden="true">
                <path fill="currentColor" d="M12 16a1 1 0 0 1-1-1V9.41l-1.3 1.3a1 1 0 1 1-1.4-1.42l3-3a1 1 0 0 1 1.4 0l3 3a1 1 0 1 1-1.4 1.42L13 9.4V15a1 1 0 0 1-1 1Z"/>
                <path fill="currentColor" d="M7 20a5 5 0 0 1-1.62-9.73A7 7 0 0 1 19 9a6 6 0 0 1 1 11.9V21H7Z"/>
              </svg>
              <p style="margin:6px 0 4px; font-weight:600">Drop files here</p>
              <p class="muted text-sm" style="margin:0">or</p>
              <!-- label triggers file picker when clicked -->
              <label id="pick" for="file-input" class="pick-btn" role="button">Choose files</label>
            </div>
            <p id="dz-hint" class="help" style="margin-top:10px">You can also paste files here.</p>
          </div>

          <div class="actions" style="margin-top:10px">
            <div id="totals" class="muted text-sm">Total: 0 MB (limit 50 MB)</div>
            <button id="clear-all" class="link" type="button" disabled>Clear all</button>
          </div>

          <div id="file-list" class="filelist" style="display:none"></div>
          <div id="total-err" class="error" role="alert" style="display:none"></div>
        </div>
      </div>
    </section>

    <div class="actions">
      <div class="tiny">By uploading, you confirm you have the right to share these documents.</div>
      <button id="submit" class="primary" type="button">Create business & upload</button>
    </div>

    <div id="live" class="status" role="status" aria-live="polite"></div>

    <div id="progress-wrap" class="card" style="display:none; margin-top:14px">
      <div class="text-sm" style="margin-bottom:8px">Uploading… <span id="pct">0%</span></div>
      <div class="progress"><div id="bar" class="bar"></div></div>
    </div>

    <div id="result" class="result" style="display:none"></div>
  </div>

  <script>
  (function(){
    // --- Config ---
    const ACCEPTED = ["pdf","csv","txt","docx","xlsx","xls"];
    const MAX_MB = 50;

    // --- Elements ---
    const nameEl = document.getElementById('biz-name');
    const slugEl = document.getElementById('biz-slug');
    const emailEl = document.getElementById('biz-email');

    const nameErr = document.getElementById('name-err');
    const slugErr = document.getElementById('slug-err');
    const emailErr = document.getElementById('email-err');

    const dz = document.getElementById('dz');
    const input = document.getElementById('file-input');
    const pick = document.getElementById('pick');
    const fileList = document.getElementById('file-list');
    const totals = document.getElementById('totals');
    const totalErr = document.getElementById('total-err');
    const clearAll = document.getElementById('clear-all');

    const live = document.getElementById('live');
    const submitBtn = document.getElementById('submit');

    const progressWrap = document.getElementById('progress-wrap');
    const bar = document.getElementById('bar');
    const pct = document.getElementById('pct');
    const result = document.getElementById('result');

    // --- State ---
    let files = []; // {file, id}
    let submitting = false;

    // --- Helpers ---
    const ext = (name) => (name.toLowerCase().match(/\.([a-z0-9]+)$/)||[])[1] || "";
    const mb = (bytes) => Math.round((bytes/1048576)*10)/10;
    const totalMB = () => files.reduce((a,f)=>a+mb(f.file.size),0);
    const say = (msg, type=""){ live.textContent = msg; live.className = "status" + (type ? " "+type : ""); };

    function setError(el, errEl, msg){
      errEl.style.display = msg ? "" : "none";
      errEl.textContent = msg || "";
      el.setAttribute("aria-invalid", msg ? "true" : "false");
    }

    function validateFields(){
      const name = nameEl.value.trim();
      const slug = slugEl.value.trim();
      const email = emailEl.value.trim();

      setError(nameEl, nameErr, name ? "" : "Business name is required.");
      setError(slugEl, slugErr, !slug ? "Slug is required." : (/^[-a-z0-9]+$/i.test(slug) ? "" : "Use only letters, numbers, and hyphens."));
      setError(emailEl, emailErr, email && !/\S+@\S+\.\S+/.test(email) ? "Enter a valid email." : "");

      const tot = totalMB();
      totals.textContent = `Total: ${tot} MB (limit ${MAX_MB} MB)`;
      const tooBig = tot > MAX_MB ? `Total size ${tot}MB exceeds ${MAX_MB}MB.` : "";
      totalErr.style.display = tooBig ? "" : "none";
      totalErr.textContent = tooBig;

      return !(nameErr.textContent || slugErr.textContent || emailErr.textContent || tooBig);
    }

    function renderFiles(){
      clearAll.disabled = files.length===0 || submitting;
      fileList.style.display = files.length ? "" : "none";
      fileList.innerHTML = files.map(({id,file})=>{
        const e = ext(file.name).slice(0,4).toUpperCase();
        return `
          <div class="fileitem" data-id="${id}">
            <div style="display:flex; align-items:center; gap:12px; min-width:0">
              <span class="ext">${e || "FILE"}</span>
              <div style="min-width:0">
                <div class="filename" title="${file.name}">${file.name}</div>
                <div class="meta">${mb(file.size)} MB</div>
              </div>
            </div>
            <button class="remove" type="button" aria-label="Remove ${file.name}">Remove</button>
          </div>`;
      }).join("");
    }

    function addFiles(list){
      const errs=[];
      const add = [];
      for(const f of list){
        if(f.size===0){ errs.push(`${f.name} is empty.`); continue; }
        const e = ext(f.name);
        if(!ACCEPTED.includes(e)){ errs.push(`${f.name}: .${e || "(no ext)"} not allowed.`); continue; }
        add.push({ file:f, id: `${f.name}-${f.size}-${Date.now()}-${Math.random().toString(36).slice(2)}` });
      }
      if(add.length){ files = files.concat(add); renderFiles(); validateFields(); }
      if(errs.length){ say(errs.join("\n"), "error"); }
    }

    // --- Events: open picker with label ---
    // When user clicks the drop area (not on label) open picker
    dz.addEventListener('click', (e) => {
      // If click target is the label or inside the label, let the label handle it
      if(e.target.tagName.toLowerCase() !== 'label'){
        input.click();
      }
    });
    // When user presses Enter or Space on drop area, open picker
    dz.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        input.click();
      }
    });

    // Drag & drop events
    ['dragenter','dragover'].forEach(evt => {
      dz.addEventListener(evt, (e) => {
        e.preventDefault();
        if(e.dataTransfer) e.dataTransfer.dropEffect = 'copy';
        dz.classList.add('hover');
      });
    });
    ['dragleave','drop'].forEach(evt => {
      dz.addEventListener(evt, () => dz.classList.remove('hover'));
    });
    dz.addEventListener('drop', (e) => {
      e.preventDefault();
      if(submitting) return;
      const fl = e.dataTransfer?.files;
      if(fl && fl.length) addFiles(fl);
    });

    // Paste support
    dz.addEventListener('paste', (e) => {
      if(submitting) return;
      const fl = e.clipboardData?.files;
      if(fl && fl.length) addFiles(fl);
    });

    // Native file picker
    input.addEventListener('change', (e) => {
      const fl = e.target.files;
      if(fl && fl.length) addFiles(fl);
      e.target.value = '';
    });

    // Prevent default on document drop to avoid navigation
    document.addEventListener('dragover', (e) => e.preventDefault());
    document.addEventListener('drop', (e) => e.preventDefault());

    // Remove file
    fileList.addEventListener('click', (e) => {
      const btn = e.target.closest('.remove');
      if(!btn) return;
      const row = btn.closest('.fileitem');
      const id = row?.getAttribute('data-id');
      files = files.filter(f => f.id !== id);
      renderFiles();
      validateFields();
    });

    // Clear all files
    clearAll.addEventListener('click', () => {
      files = [];
      renderFiles();
      validateFields();
    });

    // Inline validation events
    nameEl.addEventListener('blur', validateFields);
    slugEl.addEventListener('input', () => {
      slugEl.value = slugEl.value.replace(/[^-a-z0-9]/ig,'');
      validateFields();
    });
    slugEl.addEventListener('blur', validateFields);
    emailEl.addEventListener('blur', validateFields);

    // Submit with XHR
    submitBtn.addEventListener('click', async () => {
      say('');
      result.style.display = 'none';
      if(!validateFields()){
        say('Please fix validation errors before submitting.', 'error');
        return;
      }
      if(files.length === 0){
        say('Please add at least one file.', 'error');
        return;
      }

      submitting = true;
      submitBtn.disabled = true;
      clearAll.disabled = true;

      progressWrap.style.display = '';
      bar.style.width = '0%';
      pct.textContent = '0%';

      try{
        const fd = new FormData();
        const businessData = {
          name: nameEl.value.trim(),
          slug: slugEl.value.trim(),
          email: emailEl.value.trim()
        };
        fd.append('businessData', JSON.stringify(businessData));
        for(const {file} of files) fd.append('files', file, file.name);

        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/admin/business/create-and-upload');

        xhr.upload.addEventListener('progress', (e) => {
          if(e.lengthComputable){
            const p = Math.round((e.loaded / e.total) * 100);
            bar.style.width = p + '%';
            pct.textContent = p + '%';
          }
        });

        xhr.onreadystatechange = () => {
          if(xhr.readyState !== 4) return;
          let data = null;
          try { data = JSON.parse(xhr.responseText); } catch(_){ }
          if(xhr.status < 200 || xhr.status >= 300 || !data || !data.success){
            const err = data?.error || xhr.responseText || `HTTP ${xhr.status}`;
            say('Upload failed: ' + err, 'error');
            progressWrap.style.display = 'none';
            submitting = false;
            submitBtn.disabled = false;
            validateFields();
            return;
          }
          const chatUrl = data.urls?.chatUrl;
          const analyticsUrl = data.urls?.analyticsUrl;
          const filesProcessed = data.upload?.filesProcessed ?? 0;

          say(`Success! Processed ${filesProcessed} file${filesProcessed===1?'':'s'}.`, 'success');
          result.style.display = '';
          result.innerHTML = `
            <strong>You're all set.</strong>
            <div class="text-sm" style="margin-top:6px">Quick links for your new business:</div>
            <ul class="text-sm" style="margin:6px 0 0 16px">
              ${chatUrl ? `<li><a href="${chatUrl}" target="_blank" rel="noopener noreferrer">Open Chat</a></li>` : ''}
              ${analyticsUrl ? `<li><a href="${analyticsUrl}" target="_blank" rel="noopener noreferrer">Open Analytics</a></li>` : ''}
            </ul>
          `;
          submitting = false;
          submitBtn.disabled = false;
          validateFields();
          bar.style.width = '100%';
          pct.textContent = '100%';
          setTimeout(() => { progressWrap.style.display = 'none'; }, 800);
        };

        xhr.onerror = () => {
          say('Network error while uploading.', 'error');
          submitting = false;
          submitBtn.disabled = false;
          progressWrap.style.display = 'none';
          validateFields();
        };

        xhr.send(fd);
      } catch(err){
        say('Unexpected error: ' + err.message, 'error');
        submitting = false;
        submitBtn.disabled = false;
        progressWrap.style.display = 'none';
        validateFields();
      }
    });

    // Init
    validateFields();
  })();
  </script>
</body>
</html>
