<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Onboard Business</title>
  <style>
    /* Basic styling for the form */
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input[type="text"], input[type="email"], input[type="file"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .btn {
      display: inline-block;
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn:hover {
      background-color: #45a049;
    }
    #status {
      margin-top: 10px;
      font-weight: bold;
    }
    #status.error {
      color: #d93025;
    }
    #status.success {
      color: #0a7d32;
    }
    #result {
      margin-top: 10px;
    }
    a {
      color: #1a73e8;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Business Onboarding</h1>
    <div class="form-group">
      <label for="biz-name">Business Name</label>
      <input id="biz-name" type="text" placeholder="Enter business name" required>
    </div>
    <div class="form-group">
      <label for="biz-slug">Slug (unique identifier)</label>
      <input id="biz-slug" type="text" placeholder="Enter unique slug" required>
    </div>
    <div class="form-group">
      <label for="biz-email">Email (optional)</label>
      <input id="biz-email" type="email" placeholder="Enter contact email">
    </div>
    <div class="form-group">
      <label for="biz-files">Upload Documents</label>
      <input id="biz-files" type="file" multiple accept=".pdf,.csv,.txt,.docx,.xlsx,.xls">
    </div>
    <button id="create-upload" class="btn">Create Business &amp; Upload Files</button>
    <div id="status"></div>
    <div id="result"></div>
  </div>

  <script>
  (function() {
    const btn = document.getElementById('create-upload');
    const nameInput = document.getElementById('biz-name');
    const slugInput = document.getElementById('biz-slug');
    const emailInput = document.getElementById('biz-email');
    const fileInput = document.getElementById('biz-files');
    const statusDiv = document.getElementById('status');
    const resultDiv = document.getElementById('result');

    function setStatus(message, type) {
      statusDiv.textContent = message;
      statusDiv.className = '';
      if (type === 'error') statusDiv.classList.add('error');
      if (type === 'success') statusDiv.classList.add('success');
    }

    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      // Clear previous messages
      setStatus('', '');
      resultDiv.innerHTML = '';

      const name = nameInput.value.trim();
      const slug = slugInput.value.trim();
      const email = emailInput.value.trim();
      const files = fileInput.files;

      if (!name || !slug) {
        setStatus('Name and slug are required.', 'error');
        return;
      }
      if (files.length === 0) {
        setStatus('Please select at least one file.', 'error');
        return;
      }
      // Check for empty files
      for (const file of files) {
        if (file.size === 0) {
          setStatus(`File ${file.name} is empty.`, 'error');
          return;
        }
      }

      setStatus('Uploading...', 'success');

      const formData = new FormData();
      // API expects JSON in `businessData`
      const businessData = { name: name, slug: slug, email: email };
      formData.append('businessData', JSON.stringify(businessData));
      // Append files under 'files'
      for (const file of files) {
        formData.append('files', file, file.name);
      }

      try {
        const response = await fetch('/admin/business/create-and-upload', {
          method: 'POST',
          body: formData
        });
        const text = await response.text();
        let data;
        try {
          data = JSON.parse(text);
        } catch (parseErr) {
          data = null;
        }
        if (!response.ok || !data || !data.success) {
          const error = data?.error || text || `HTTP ${response.status}`;
          setStatus('Upload failed: ' + error, 'error');
          return;
        }
        // Success
        const chatUrl = data.urls?.chatUrl;
        const analyticsUrl = data.urls?.analyticsUrl;
        const filesProcessed = data.upload?.filesProcessed ?? 0;
        setStatus(`Success! Processed ${filesProcessed} file(s).`, 'success');
        resultDiv.innerHTML = `
          <div>Chat URL: <a href="${chatUrl}" target="_blank">${chatUrl}</a></div>
          <div>Analytics URL: <a href="${analyticsUrl}" target="_blank">${analyticsUrl}</a></div>
        `;
      } catch (err) {
        setStatus('Network error: ' + err.message, 'error');
      }
    });
  })();
  </script>
</body>
</html>
