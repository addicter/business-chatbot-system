<!DOCTYPE html>
<html lang="en" data-theme="auto">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Business Chatbot Setup — Horizon UI (Redesigned)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* =========================
       THEME & TOKENS
       - Light/Dark via prefers-color-scheme
       - Brand color live-updatable via --brand
    ========================= */
    :root{
      /* brand + neutrals */
      --brand:#4318ff; /* updated live from color input */
      --bg: #f6f8ff;
      --bg-subtle:#f0f3ff;
      --card:#ffffff;
      --text:#111323;
      --muted:#6c7393;
      --border:#e5e9f5;
      --shadow:0 10px 30px rgba(23, 27, 41, .08);
      --radius-xl: 20px; 
      --radius-lg: 16px;
      --radius-md: 12px;
      --focus-ring: 0 0 0 4px color-mix(in oklab, var(--brand) 20%, transparent);

      /* semantic */
      --success:#06c68d;
      --warning:#ffb547; 
      --error:#e5484d;

      /* typography */
      --fs-hero: clamp(28px, 3.2vw, 36px);
      --fs-h2: 20px; 
      --fs-body: 14px; 
    }

    @media (prefers-color-scheme: dark) {
      :root{
        --bg:#0f1222;
        --bg-subtle:#10142b;
        --card:#141834;
        --text:#eff1ff;
        --muted:#a9b1d6;
        --border:#23264a;
        --shadow: 0 14px 28px rgba(0,0,0,.45);
      }
    }

    /* Optional manual theme override (toggled by button) */
    html[data-theme="light"]{ color-scheme: light; }
    html[data-theme="dark"]{ color-scheme: dark; }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: 'DM Sans', ui-sans-serif, system-ui, -apple-system, sans-serif;
      background: radial-gradient(1200px 800px at 80% -10%, color-mix(in oklab, var(--brand) 12%, transparent), transparent 70%) , var(--bg);
      color:var(--text); line-height:1.6;
    }

    a{ color: var(--brand); text-decoration: none; }
    a:hover{ text-decoration: underline; }

    /* LAYOUT */
    .shell{ max-width:1100px; margin:28px auto; padding: 0 20px; }

    .header{
      display:grid; grid-template-columns: 1fr auto; align-items:center; gap:16px; margin-bottom: 18px;
    }
    .brandmark{
      display:flex; align-items:center; gap:12px;
    }
    .logo-circle{ width:40px; height:40px; border-radius:12px; background: var(--brand); box-shadow: var(--shadow); }
    .title-wrap h1{ font-size: var(--fs-hero); margin: 0; letter-spacing: -0.02em; }
    .title-wrap p{ margin: 6px 0 0; color: var(--muted); font-size: 15px; }

    .mode-toggle{
      display:flex; align-items:center; gap:10px;
      background: var(--card); border:1px solid var(--border); border-radius: 999px; padding: 6px 10px; box-shadow: var(--shadow);
    }
    .mode-toggle button{ 
      appearance:none; border:none; background:transparent; color:var(--text); cursor:pointer; padding:6px 10px; border-radius: 999px;
    }
    .mode-toggle button.active{ background: color-mix(in oklab, var(--brand) 18%, transparent); color: white; }

    .grid{
      display:grid; grid-template-columns: 1.4fr .9fr; gap: 22px;
    }
    @media (max-width: 900px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      background: linear-gradient(180deg, color-mix(in oklab, var(--brand) 6%, var(--card)), var(--card));
      border:1px solid var(--border); border-radius: var(--radius-xl); box-shadow: var(--shadow);
    }
    .card.pad{ padding: 26px; }

    .sticky{ position: sticky; top: 18px; }

    .section-title{
      display:flex; align-items:center; justify-content:space-between; margin-bottom: 12px;
    }

    /* FORM */
    form{ display:block }

    .fieldset{ margin-bottom: 18px; }
    .fieldset > h3{ font-size: var(--fs-h2); margin: 12px 2px; }
    .fieldset .hint{ color: var(--muted); font-size: 13px; margin: 2px 2px 12px; }

    .form-grid{ display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 768px){ .form-grid{ grid-template-columns:1fr; } }

    .control{ display:block }
    .control label{
      display:flex; align-items:center; gap:8px; font-size: 13px; font-weight: 600; margin: 6px 2px;
    }
    .required:after{ content: " *"; color: var(--error); font-weight: 700; }

    .input, .textarea, .select{
      width:100%; padding: 14px 14px; border-radius: var(--radius-lg);
      border:1px solid var(--border); background: var(--card); color: var(--text); font-size: var(--fs-body);
      transition: box-shadow .2s ease, border-color .2s ease, transform .08s ease;
    }
    .input:focus, .textarea:focus, .select:focus{ outline: none; border-color: var(--brand); box-shadow: var(--focus-ring); }
    .textarea{ min-height: 110px; resize: vertical; }

    .inline{ display:flex; align-items:center; gap:10px; }

    .help{ color: var(--muted); font-size:12px; margin-top: 6px; }

    /* UPLOAD */
    .upload-zone{
      border:2px dashed var(--border); border-radius: var(--radius-lg);
      background: color-mix(in oklab, var(--brand) 4%, var(--bg-subtle));
      padding: 28px; text-align:center; cursor: pointer; transition: border-color .2s ease, background .2s ease, transform .06s ease;
    }
    .upload-zone:hover{ transform: translateY(-1px); }
    .upload-zone.dragover{ border-color: var(--brand); background: color-mix(in oklab, var(--brand) 10%, var(--bg-subtle)); }
    .upload-zone .icon{ width:48px; height:48px; margin: 0 auto 10px; color: var(--muted); }
    .upload-title{ font-weight: 600; }
    .upload-sub{ color: var(--muted); font-size: 13px; }

    .file-list{ margin-top: 12px; display:flex; flex-direction: column; gap: 10px; }
    .file-item{
      display:flex; align-items:center; justify-content: space-between; gap: 8px; padding: 10px 12px; border:1px solid var(--border);
      background: var(--card); border-radius: var(--radius-md);
    }
    .file-info{ display:flex; align-items:center; gap: 10px; }
    .file-badge{ width:28px; height:28px; border-radius: 8px; background: color-mix(in oklab, var(--brand) 25%, black 6%);
      display:grid; place-items:center; color: #fff; font-size: 12px; font-weight: 700;
    }
    .file-meta{ display:flex; flex-direction: column; line-height: 1.3; }
    .file-meta .name{ font-size: 13px; font-weight: 600; }
    .file-meta .size{ font-size: 12px; color: var(--muted); }
    .file-remove{ border:none; border-radius: 10px; background: color-mix(in oklab, var(--error) 20%, transparent); color: #fff; width: 28px; height: 28px; cursor: pointer; }

    /* FEATS */
    .feature-list{ display:grid; grid-template-columns: repeat(auto-fit, minmax(210px, 1fr)); gap: 12px; }
    .feature{ 
      background: var(--card); border:1px solid var(--border); border-radius: var(--radius-md); padding: 16px; text-align:center; box-shadow: var(--shadow);
    }
    .feature .emoji{ font-size: 22px; margin-bottom: 6px; }
    .feature .title{ font-size: 13px; font-weight: 600; }

    /* BUTTONS */
    .actions{ display:flex; gap: 12px; justify-content: center; margin-top: 20px; }
    .btn{
      appearance:none; border:none; cursor:pointer; border-radius: 14px; font-weight: 600; font-size: 14px; padding: 12px 18px; display:inline-flex; align-items:center; gap:8px; transition: transform .06s ease, filter .2s ease;
    }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.02); }
    .btn:active{ transform: translateY(0); }
    .btn-primary{ color:white; background: linear-gradient(180deg, color-mix(in oklab, var(--brand) 85%, black 0%), color-mix(in oklab, var(--brand) 65%, black 6%)); box-shadow: var(--shadow); }
    .btn-success{ color:white; background: linear-gradient(180deg, color-mix(in oklab, var(--success) 90%, black 0%), color-mix(in oklab, var(--success) 70%, black 8%)); }
    .btn-ghost{ background: color-mix(in oklab, var(--brand) 10%, transparent); color: white; }

    /* ALERTS & RESULTS */
    .results{ margin-top: 20px; }
    .alert{ padding: 14px 16px; border-radius: 12px; border:1px solid var(--border); font-size: 14px; margin: 10px 0; }
    .alert-success{ background: color-mix(in oklab, var(--success) 8%, transparent); color: color-mix(in oklab, var(--success) 60%, white); }
    .alert-error{ background: color-mix(in oklab, var(--error) 8%, transparent); color: color-mix(in oklab, var(--error) 65%, white); }
    .alert-info{ background: color-mix(in oklab, var(--brand) 6%, transparent); color: color-mix(in oklab, var(--brand) 65%, white); }

    .loading{ display:none; text-align:center; padding: 32px; }
    .spinner{ width: 44px; height: 44px; border: 3px solid color-mix(in oklab, var(--brand) 20%, transparent); border-top-color: var(--brand); border-radius: 999px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    .result-card{ background: var(--card); border: 1px solid var(--border); border-left: 4px solid var(--brand); border-radius: 12px; padding: 18px; margin: 10px 0; }
    .result-success{ border-left-color: var(--success); }
    .result-error{ border-left-color: var(--error); }

    .url-display{ background: var(--bg-subtle); border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: 13px; word-break: break-all; margin: 6px 0; display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .copy{ border: 1px solid var(--border); border-radius: 8px; padding: 6px 8px; background: var(--card); cursor: pointer; }

    .small{ font-size: 12px; color: var(--muted); }

    /* FOOTER */
    footer{ margin: 30px 0 20px; text-align:center; color: var(--muted); font-size: 12px; }
  </style>
</head>
<body>
  <div class="shell">
    <header class="header">
      <div class="brandmark">
        <div class="logo-circle" id="brandSwatch" aria-hidden="true"></div>
        <div class="title-wrap">
          <h1>Business Chatbot Setup</h1>
          <p>Create your business profile and upload documents in one streamlined flow</p>
        </div>
      </div>
      <div class="mode-toggle" role="group" aria-label="Color theme">
        <button type="button" id="lightBtn" aria-pressed="false" title="Light">☀️</button>
        <button type="button" id="autoBtn" class="active" aria-pressed="true" title="Auto">🌓</button>
        <button type="button" id="darkBtn" aria-pressed="false" title="Dark">🌙</button>
      </div>
    </header>

    <div class="grid">
      <!-- MAIN FORM -->
      <div class="card pad">
        <form id="setupForm" enctype="multipart/form-data" aria-describedby="formHelp">
          <p id="formHelp" class="small">Fields marked with <span style="color:var(--error)">*</span> are required.</p>

          <!-- Business Information -->
          <section class="fieldset">
            <h3>Business Information</h3>
            <p class="hint">Tell us who you are. These details power your chatbot profile.</p>
            <div class="form-grid">
              <div class="control">
                <label for="name" class="required">Business Name</label>
                <input id="name" class="input" required placeholder="Acme Coaching Institute" autocomplete="organization"/>
              </div>
              <div class="control">
                <label for="slug" class="required">URL Slug <span class="small">(letters, numbers, hyphens only)</span></label>
                <input id="slug" class="input" required pattern="[a-z0-9-]+" placeholder="acme-coaching" inputmode="latin"/>
                <div class="help">Public paths like <code>/b/&lt;slug&gt;</code> use this value.</div>
              </div>
            </div>

            <div class="control">
              <label for="description">Business Description</label>
              <textarea id="description" class="textarea" placeholder="Brief description of your business and services..."></textarea>
            </div>

            <div class="form-grid">
              <div class="control">
                <label for="email">Business Email</label>
                <input id="email" type="email" class="input" placeholder="contact@acme-coaching.com" autocomplete="email"/>
              </div>
              <div class="control">
                <label for="phone">Phone Number</label>
                <input id="phone" type="tel" class="input" placeholder="+91-9876543210" autocomplete="tel"/>
              </div>
            </div>

            <div class="control">
              <label for="address">Address</label>
              <input id="address" class="input" placeholder="123 Main Street, City, State" autocomplete="street-address"/>
            </div>

            <div class="form-grid">
              <div class="control">
                <label for="website">Website URL</label>
                <input id="website" type="url" class="input" placeholder="https://acme-coaching.com" inputmode="url"/>
              </div>
              <div class="control">
                <label for="hours">Business Hours</label>
                <input id="hours" class="input" placeholder="Mon–Fri 9AM–6PM, Sat 10AM–2PM"/>
              </div>
            </div>

            <div class="control">
              <label for="maps">Google Maps URL</label>
              <input id="maps" type="url" class="input" placeholder="https://maps.google.com/?q=Your+Business+Name" inputmode="url"/>
            </div>

            <div class="form-grid">
              <div class="control">
                <label for="primaryColor">Brand Color</label>
                <div class="inline">
                  <input id="primaryColor" type="color" class="input" value="#4318ff" style="padding:6px; height:44px; width:64px"/>
                  <span class="help">Used across buttons and accents.</span>
                </div>
              </div>
              <div class="control">
                <label for="logoUrl">Logo URL (Optional)</label>
                <input id="logoUrl" type="url" class="input" placeholder="https://example.com/logo.png" inputmode="url"/>
                <div id="logoPreviewHelp" class="help">Paste a logo URL to preview at right.</div>
              </div>
            </div>

            <div class="control">
              <label for="welcomeMessage">Welcome Message</label>
              <textarea id="welcomeMessage" class="textarea" placeholder="Hi! Welcome to Acme Coaching. How can I help you today?"></textarea>
            </div>

            <div class="feature-list" aria-label="Key features">
              <div class="feature"><div class="emoji">🔐</div><div class="title">Secure Hash URLs</div></div>
              <div class="feature"><div class="emoji">📧</div><div class="title">Email Notifications</div></div>
              <div class="feature"><div class="emoji">🎯</div><div class="title">Lead Capture</div></div>
              <div class="feature"><div class="emoji">📊</div><div class="title">Analytics Dashboard</div></div>
            </div>
          </section>

          <hr style="border:0;border-top:1px solid var(--border); margin:22px 0"/>

          <!-- Upload Section -->
          <section class="fieldset">
            <h3>Upload Business Documents</h3>
            <p class="hint">Upload PDFs, Excel sheets, Word documents, or text files containing your business information, course details, pricing, policies, etc.</p>

            <div id="uploadZone" class="upload-zone" tabindex="0" role="button" aria-label="File upload area: click or drag and drop files" aria-describedby="uploadHelp">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                <path d="M17 8l-5-5-5 5"/>
                <path d="M12 3v12"/>
              </svg>
              <div class="upload-title">Drag & Drop files here</div>
              <div class="upload-sub" id="uploadHelp">or click to browse • PDF, Excel, Word, CSV, TXT • Max 10MB each</div>
              <input type="file" id="fileInput" multiple accept=".pdf,.csv,.xlsx,.xls,.docx,.txt" style="display:none" />
            </div>

            <div id="fileList" class="file-list" aria-live="polite"></div>
          </section>

          <div class="actions">
            <button type="submit" class="btn btn-primary">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><path d="M22 4L12 14.01l-3-3"/></svg>
              Create Business & Upload Files
            </button>
          </div>
        </form>

        <div id="loading" class="loading" aria-live="assertive">
          <div class="spinner"></div>
          <p>Creating your business chatbot and processing files...</p>
        </div>

        <div id="results" class="results" style="display:none;" aria-live="polite"></div>
      </div>

      <!-- PREVIEW / SUMMARY SIDEBAR -->
      <aside class="card pad sticky" aria-label="Live Preview">
        <div class="section-title"><h3 style="margin:0">Live Preview</h3></div>
        <div id="logoPreview" style="display:grid; place-items:center; width:100%; height:140px; background: var(--bg-subtle); border:1px dashed var(--border); border-radius: 14px; margin-bottom: 14px;">
          <span class="small">Logo preview shows here</span>
        </div>
        <div style="display:grid; grid-template-columns: 1fr; gap:10px;">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
            <span class="small">Brand color</span>
            <div id="brandPill" style="height:26px; min-width: 60px; border-radius: 999px; background: var(--brand);"></div>
          </div>
          <div>
            <div class="small">Previewed Chat URL</div>
            <div class="url-display"><span id="slugPreview">/b/&lt;slug&gt;</span></div>
          </div>
        </div>
      </aside>
    </div>

    <footer>© <span id="year"></span> Horizon UI — Setup</footer>
  </div>

  <script>
    // =========================
    // UTILities & State
    // =========================
    let selectedFiles = [];
    const $ = (sel)=> document.querySelector(sel);

    const uploadZone = $('#uploadZone');
    const fileInput = $('#fileInput');
    const fileList = $('#fileList');
    const resultsEl = $('#results');

    const MAX_MB = 10; // soft limit reflected in UI

    const extBadge = (name) => (name.split('.').pop() || '').toUpperCase().slice(0,4);
    const fmtMB = bytes => (bytes / (1024 * 1024)).toFixed(2) + ' MB';

    // =========================
    // Theme toggle (Light / Auto / Dark)
    // =========================
    const lightBtn = $('#lightBtn');
    const autoBtn = $('#autoBtn');
    const darkBtn = $('#darkBtn');

    const setTheme = (mode)=>{
      document.documentElement.setAttribute('data-theme', mode);
      [lightBtn, autoBtn, darkBtn].forEach(b=> b.classList.remove('active'));
      if(mode==='light'){ lightBtn.classList.add('active'); }
      else if(mode==='dark'){ darkBtn.classList.add('active'); }
      else { autoBtn.classList.add('active'); }
      try{ localStorage.setItem('horizon-theme', mode); }catch(e){}
    }

    ;(()=>{
      const saved = localStorage.getItem('horizon-theme');
      setTheme(saved || 'auto');
      lightBtn.onclick = ()=> setTheme('light');
      autoBtn.onclick = ()=> setTheme('auto');
      darkBtn.onclick = ()=> setTheme('dark');
    })();

    // =========================
    // Live brand & preview
    // =========================
    const brandSwatch = $('#brandSwatch');
    const brandPill = $('#brandPill');
    const colorPicker = $('#primaryColor');
    colorPicker.addEventListener('input', (e)=>{
      const val = e.target.value || '#4318ff';
      document.documentElement.style.setProperty('--brand', val);
      brandSwatch.style.background = val;
      brandPill.style.background = val;
    });

    const slugInput = $('#slug');
    const nameInput = $('#name');
    const slugPreview = $('#slugPreview');

    const sanitizeSlug = (v)=> v.toLowerCase().replace(/[^a-z0-9\-\s]/g,'').replace(/\s+/g,'-').replace(/-+/g,'-').slice(0,50);

    nameInput.addEventListener('input', (e)=>{
      if(!slugInput.value){
        slugInput.value = sanitizeSlug(e.target.value);
        slugPreview.textContent = '/b/' + slugInput.value;
      }
    });
    slugInput.addEventListener('input', (e)=>{
      e.target.value = sanitizeSlug(e.target.value);
      slugPreview.textContent = '/b/' + e.target.value;
    });

    const logoUrl = $('#logoUrl');
    const logoPreview = $('#logoPreview');
    const updateLogoPreview = ()=>{
      const url = logoUrl.value.trim();
      if(!url){ logoPreview.innerHTML = '<span class="small">Logo preview shows here</span>'; return; }
      logoPreview.innerHTML = `<img src="${url}" alt="Logo preview" style="max-height:100px; max-width: 90%; object-fit: contain;" onerror="this.parentElement.innerHTML='\n        <span class=\"small\">Could not load logo. Check URL.</span>'"/>`;
    }
    logoUrl.addEventListener('change', updateLogoPreview);

    // =========================
    // Upload zone interactions (keyboard + drag&drop)
    // =========================
    uploadZone.addEventListener('click', ()=> fileInput.click());
    uploadZone.addEventListener('keypress', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); fileInput.click(); }});

    uploadZone.addEventListener('dragover', (e)=>{ e.preventDefault(); uploadZone.classList.add('dragover'); });
    uploadZone.addEventListener('dragleave', ()=> uploadZone.classList.remove('dragover'));
    uploadZone.addEventListener('drop', (e)=>{
      e.preventDefault(); uploadZone.classList.remove('dragover');
      handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', (e)=> handleFiles(e.target.files));

    function handleFiles(files){
      const arr = Array.from(files);
      const filtered = [];
      arr.forEach(f=>{
        const validType = /(pdf|csv|xlsx|xls|docx|txt)$/i.test(f.name);
        const withinSize = f.size <= MAX_MB * 1024 * 1024;
        if(!validType){ showAlert(`File type not allowed: ${f.name}`, 'error'); return; }
        if(!withinSize){ showAlert(`File exceeds ${MAX_MB}MB: ${f.name}`, 'error'); return; }
        filtered.push(f);
      });
      selectedFiles = [...selectedFiles, ...filtered];
      renderFileList();
    }

    function renderFileList(){
      if(selectedFiles.length===0){ fileList.innerHTML = ''; return; }
      fileList.innerHTML = selectedFiles.map((file, index)=>`
        <div class="file-item">
          <div class="file-info">
            <div class="file-badge" aria-hidden="true">${extBadge(file.name)}</div>
            <div class="file-meta">
              <div class="name">${file.name}</div>
              <div class="size">${fmtMB(file.size)}</div>
            </div>
          </div>
          <button type="button" class="file-remove" aria-label="Remove ${file.name}" onclick="removeFile(${index})">×</button>
        </div>
      `).join('');
    }

    window.removeFile = (index)=>{ selectedFiles.splice(index,1); renderFileList(); }

    function showAlert(message, type='info'){
      const div = document.createElement('div');
      div.className = `alert alert-${type}`;
      div.role = 'status';
      div.textContent = message;
      resultsEl.style.display = 'block';
      resultsEl.appendChild(div);
      setTimeout(()=> div.remove(), 4500);
    }

    // =========================
    // FORM SUBMIT
    // =========================
    const setupForm = $('#setupForm');

    setupForm.addEventListener('submit', async (e)=>{
      e.preventDefault();

      const formData = new FormData();
      const businessData = {
        slug: $('#slug').value.toLowerCase().replace(/[^a-z0-9-]/g, ''),
        name: $('#name').value,
        description: $('#description').value,
        email: $('#email').value,
        phone: $('#phone').value,
        address: $('#address').value,
        website: $('#website').value,
        hours: $('#hours').value,
        maps_url: $('#maps').value,
        primary_color: $('#primaryColor').value,
        logo_url: $('#logoUrl').value,
        welcome_message: $('#welcomeMessage').value || 'Hi! How can I help you today?',
        enable_email_notifications: true,
        enable_lead_capture: true
      };

      formData.append('businessData', JSON.stringify(businessData));
      selectedFiles.forEach(file => formData.append('files', file));

      setupForm.style.display = 'none';
      $('#loading').style.display = 'block';
      resultsEl.style.display = 'block';
      resultsEl.innerHTML = '';

      try{
        const response = await fetch('/admin/business/create-and-upload', { method:'POST', body: formData });
        let result;
        try{ result = await response.json(); }
        catch(err){ throw new Error('Invalid server response'); }

        if(result.success){
          resultsEl.innerHTML = `
            <div class="result-card result-success">
              <h3 style="margin:0 0 10px; color: color-mix(in oklab, var(--success) 70%, white);">✅ Success! Your business chatbot is ready</h3>
              <div style="display:grid; gap:10px; margin: 12px 0 16px;">
                <div>
                  <h4 style="margin:0 0 6px;">🔐 Chat URL</h4>
                  <div class="url-display"><span>${result.urls.chatUrl}</span> <button class="copy" data-clip="${result.urls.chatUrl}">Copy</button></div>
                </div>
                <div>
                  <h4 style="margin:0 0 6px;">📊 Analytics URL</h4>
                  <div class="url-display"><span>${result.urls.analyticsUrl}</span> <button class="copy" data-clip="${result.urls.analyticsUrl}">Copy</button></div>
                </div>
              </div>
              <div>
                <h4 style="margin:8px 0">📁 Upload Results</h4>
                <p>Files processed: ${result.upload.filesProcessed}/${result.upload.totalFiles}</p>
                <p>AI chunks created: ${result.upload.totalChunks}</p>
              </div>
            </div>
          `;

          if(Array.isArray(result.upload?.results) && result.upload.results.length){
            const fileResults = result.upload.results.map(file=>`
              <div class="result-card ${file.status==='success' ? 'result-success' : 'result-error'}">
                <strong>${file.filename}</strong> — ${file.status}
                ${file.chunks ? `<br><small>Created ${file.chunks} AI chunks, Category: ${file.category}</small>` : ''}
                ${file.error ? `<br><small>Error: ${file.error}</small>` : ''}
              </div>
            `).join('');

            resultsEl.innerHTML += `<div style="margin-top: 14px;">
              <h4 style="margin:0 0 8px">File Processing Details</h4>
              ${fileResults}
            </div>`;
          }

          // Attach copy handlers
          resultsEl.querySelectorAll('.copy').forEach(btn=>{
            btn.addEventListener('click', async ()=>{
              try{ await navigator.clipboard.writeText(btn.dataset.clip); btn.textContent = 'Copied'; setTimeout(()=> btn.textContent='Copy', 1200); }
              catch(e){ btn.textContent='Copy failed'; setTimeout(()=> btn.textContent='Copy', 1200); }
            })
          });

        }else{
          resultsEl.innerHTML = `
            <div class="result-card result-error">
              <h3 style="margin:0 0 10px; color: color-mix(in oklab, var(--error) 70%, white);">❌ Error</h3>
              <p>${result.error || 'Unknown error occurred'}</p>
            </div>
          `;
          setupForm.style.display = 'block';
        }
      }catch(err){
        console.error('Setup error:', err);
        resultsEl.innerHTML = `
          <div class="result-card result-error">
            <h3 style="margin:0 0 10px; color: color-mix(in oklab, var(--error) 70%, white);">❌ Connection Error</h3>
            <p>Please check your internet connection and try again.</p>
          </div>
        `;
        setupForm.style.display = 'block';
      }finally{
        $('#loading').style.display = 'none';
      }
    });

    // Footer year
    $('#year').textContent = new Date().getFullYear();

    // Initialize previews on load
    updateLogoPreview();
  </script>
</body>
</html>
